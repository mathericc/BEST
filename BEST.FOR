c23456 First Line of program best rewrite

	  Program Best

	  IMPLICIT REAL*8 (A-H,O-Z) 
	  DOUBLE PRECISION NAME
	  DIMENSION RCC(111,7), TITLE(20), VB(111), PH(111), NAME(7)
	  DIMENSION AA(111,7), T(111,7)
	  DIMENSION CC(7),CS(111), Y(7), PHCALC(111), A(7,7)
	  DIMENSION D(7)
	  REAL*8 MMC(7), LBETA(111), MMACID, NB
	  INTEGER*2 BELL
	  INTEGER IS(111,7), IC(7)
	  CHARACTER*2 NSTR
	  COMMON /AINP/ SIGFIT, IS, IC, VB, PH, LBETA, MMC, NAME, TITLE
	  COMMON /AAAA/ BELL, I1, I2, ISTEP, NDP, NS, NC, AA, RCC, T
	  COMMON /BBBB/ PHCOR, VO, NB, MMACID
	  COMMON /CCCC/ CC, CS, PHCALC
	  COMMON /DDDD/ NOPT, FAST
	  COMMON /EEEE/ A
	  COMMON /GGGG/ NREF
	  COMMON /LLLL/ LUNI, LUNO
	  OPEN(1, FILE='FOR001.DAT', STATUS='UNKNOWN')
	  OPEN(7, FILE='ERROR.DAT', STATUS='UNKNOWN')
	  NREF = 0
	  BELL = 7
	  LUNI = 5
	  LUNO = 6
	  FAST = 1.
	  WRITE(LUNO, 1) BELL
1	  FORMAT(21X, 'PROGRAM BEST'), /
	 1,21X,'RAMUNAS J. MONTEKAITIS'/
	 2,21X,'VERSION 10/10/91',A4,/
	 3,21X,'REAL*8  VARIABLES',//) 
	  WRITE(LUNO, 101)
101	  FORMAT(//,'FILE USAGE:')
	  WRITE(LUNO, 102)
102	  FORMAT('FOR001.DAT - OUTPUT', /,  
	 1' FOR002.DAT - SCRATCH (COMPONENTS)',/,
	 2' FOR003.DAT - SCRATCH (LOG BETA VALUES)',/,
	 3' FOR004.DAT - INPUT (ORIGINAL DATA)',/,
	 4' ERROR.DAT - (LOGGING OPTION 31)',/)
9	  FORMAT(I3)
	  DO 88 K = 1,7
	  DO 88 I = 1,111
88	  RCC(I,K) = 0.
	  MM = 0
27	  CALL INPUT(MM)
	  I1 = 1
	  I2 = NDP
	  ISTEP = 1
	  CALL OPTION
	  NDUM = 1
	  CALL BODY(NDUM)
	  GO TO 98
45	  CALL REFINE
	  GO TO 98
36	  CALL OUTPUT
98	  WRITE(LUNO, 77) BELL
77	  FORMAT(/,1X,A4,'27=TOP 36=OUTPUT 45=REFINE 54=OPTIONS', 
	 1' 63=COMPUTE 72=STOP?',$)
	  READ(LUNI,99) NSTR
99    FORMAT(A2)
	  IF(NSTR.EQ.'27') GO TO 27
	  IF(NSTR.EQ.'36') GO TO 36
	  IF(NSTR.EQ.'45') GO TO 45
	  IF(NSTR.EQ.'54') GO TO 54
	  IF(NSTR.EQ.'63') GO TO 59
	  IF(NSTR.EQ.'72') STOP
54	  CALL OPTION
	  GO TO 98
59	  NDUM=-1
	  CALL BODY(NDUM)
	  GO TO 98
	  END 



	  SUBROUTINE OPTION
	  IMPLICIT REAL*8 (A-H,O-Z) 
	  DOUBLE PRECISION NAME
	  DIMENSION RCC(111,7), TITLE(20), VB(111), PH(111), NAME(7)
	  DIMENSION AA(111,7), T(111,7)
	  DIMENSION CC(7),CS(111), Y(7), PHCALC(111), A(7,7)
	  DIMENSION D(7), BLER(111)
	  REAL*8 MMC(7), LBETA(111), MMACID, NB
	  INTEGER IS(111,7), IC(7)
	  INTEGER*2 BELL, SILENT
	  CHARACTER*2 MCH
	  COMMON /AINP/ SIGFIT, IS, IC, VB, PH, LBETA, MMC, NAME, TITLE
	  COMMON /AAAA/ BELL, I1, I2, ISTEP, NDP, NS, NC, AA, RCC, T
	  COMMON /BBBB/ PHCOR, VO, NB, MMACID
	  COMMON /CCCC/ CC, CS, PHCALC
	  COMMON /DDDD/ NOPT, FAST
	  COMMON /EEEE/ A
	  COMMON /LLLL/ LUNI, LUNO
	  DATA SILENT /0/
	  NOPT=1
	  GO TO 70
17	  WRITE(LUNO, 2) BELL
2	  FORMAT(1X,A4,'Enter speed factor 1-5 or hit RETURN',$)
	  READ(LUNI, 21, ERR=17) I
21    FORMAT(I2)
	  IF(I.LT.0) NOPT=0
	  IF(I.GT.6) NOPT=1
	  IF(I.GT.0.AND.I.LT.6) FAST = 10.0**I
	  ISPEED=I
	  GO TO 70
18	  WRITE(LUNO, 10) BELL
10    FORMAT(1X, A4, 'INITIAL,FINAL(or -1), STEP(3I2) or RETURN', $)
	  READ(LUNI, 20,ERR=18) K1,K2,KSTEP
20 	  FORMAT(3I2)
	  IF(K1.GT.0.AND.K1.LE.NDP) I1 = K1
	  IF(K2.GT.0.AND.K2.LE.NDP)	I2 = K2
	  IF(KSTEP.GT.0) ISTEP = KSTEP
	  IF(K2.LT.0) I2=NDP
	  GO TO 70
59    DO 60 I=1, NS
60    WRITE(LUNO,47) I,LBETA(I),(IS(I,K),NAME(K),K=1, NC)
47    FORMAT(1X,I2,F9.4,1X,8(I2,A9,1X))
48    WRITE(LUNO, 49) BELL
49	  FORMAT(1X, A4, 'ENTER "I" OF LOG BETA TO CHANGED or RETURN',$)
	  READ(LUNI, 51, ERR=48) I
51	  FORMAT(I2)
	  IF(I.LT.1) GO TO 70
	  IF(I.GT.NS) GO TO 48
56 	  WRITE(LUNO, 53) BELL,I
53 	  FORMAT(1X, A4, 'ENTER NEW LOG BETA(',I2,')?',$)
      READ(LUNI, 57, ERR=56) LBETA(I)
57	  FORMAT(F10.6)
	  GO TO 59
	  WRITE(LUNO,68)
68    FORMAT(' OPTIONS:')
      WRITE(LUNO,69) ISPEED,I1,I2,ISTEP
69    FORMAT(5X,'14=REMOVE OR ADD DATA',/,5X,
     X'16=SILENT MODE(15=RESTORE)',/,5X,
     X'17=SPEED FACTOR(',I2,')',/,5X,
     X'18=POINTS(',3I3,')',/,5X,
     X'19= BETA VALUES')
	  WRITE(LUNO,71) BELL, NB, MMACID,VO,PHCOR
71    FORMAT (1X,A4, 1X,'20= MILLIMOLES',/,5X,
     X'21=NORMALITY BASE(',F9.5,')',/,5X,
	 X'22=MILLIMOLES EXCESS ACID(',F9.5,')',/,5X,
	 X'23=INITIAL VOLUME(',F9.5,')',/,5X,
	 X'24=(RETURN) = END OF CHANGES ?',/,5X,
	 X'25=PARABOLIC FUNCTION ?',/,5X,
	 X'26=APPORTION REMAINDER HYDROGEN TO EXCESS ACID ?',/,5X,
	 X'27=READ CURRENT LOG BETA VALUES ?',/,5X,
	 X'28=READ CURRENT MILLIMOLES ?',/,5X,
	 X'29=CORRECTION ON PH CALCD(',F6.3,')?',/,5X,
	 X'30=AUTOREFINE MILLIMOLES ?',/,5X,
	 X'31=ERROR ANALYSIS ?',$)
	  READ (LUNI,52) MCH
52	  FORMAT (A2)
	  IF(MCH.EQ.' '.OR.MCH.EQ.'24'.OR.MCH.EQ.'63') GO TO 80
	  IF(MCH.EQ.'14') GO TO 5300
	  IF(MCH.EQ.'15') BELL=7
	  IF(MCH.EQ.'16') BELL=SILENT
	  IF(MCH.EQ.'17') GO TO 17
	  IF(MCH.EQ.'18') GO TO 18
	  IF(MCH.EQ.'19') GO TO 59
	  IF(MCH.EQ.'20') GO TO 75
	  IF(MCH.EQ.'21') GO TO 5225
	  IF(MCH.EQ.'22') GO TO 5225
	  IF(MCH.EQ.'23') GO TO 5225
	  IF(MCH.EQ.'24') GO TO 80
	  IF(MCH.EQ.'25') CALL PARB
	  IF(MCH.EQ.'26') GO TO 5250
	  IF(MCH.EQ.'27') GO TO 5215
	  IF(MCH.EQ.'28') GO TO 5220
	  IF(MCH.EQ.'29') GO TO 5225
	  IF(MCH.EQ.'30') CALL STOICH(NC, NS)
	  IF(MCH.EQ.'31') CALL ERROR
	  GO TO 70
5225  CONTINUE
	  WRITE(LUNO,73) BELL
73	  FORMAT(1X,A4,'NOW TYPE IN VALUE?',$)
	  IF(MCH.EQ.'21') READ (LUNI,57, ERR=5228) NB
	  IF(MCH.EQ.'22') READ (LUNI,57,ERR=5228) MMACID
	  IF(MCH.EQ.'23') READ (LUNI,57,ERR=5228) VO
	  IF(MCH.EQ.'29') READ(LUNI,57,ERR=5228) PHCOR
	  GO TO 70
75	  WRITE(LUNO,76) (I,NAME(I),MMC(I),I=1,NC)
76	  FORMAT (1X,I2, 1X,A8, F10.5,3X, 'MMOLES')
7601  WRITE(LUNO,77) BELL
77	  FORMAT (1X,A4, 'TYPE IN "I"? or RETURN ',$)
58	  READ(LUNI,581, ERR=7601) SSI
581	  FORMAT(F2.0)
      I=SSI
	  IF(I.GT.NC) GO TO 75
	  IF(I.LE.0) GO TO 70
7801  WRITE(LUNO,78) BELL,I
78	  FORMAT (1X,A4, 'TYPE IN MMC(',I2,')? ',$)
	  READ(LUNI,57, ERR=7801) MMC(I)
	  GO TO 75
80	  MM=1
	  CALL INPUT (MM)
	  MM=0
	  RETURN
5215  OPEN (3,FILE='FOR003.DAT',STATUS='UNKNOWN')
	  READ (3,5216) (LBETA(J),J=1,NS)
5216  FORMAT(F16.6)
	  CLOSE (3)
      GO TO 5225
5220  OPEN (2, FILE='FOR002.DAT', STATUS='UNKNOWN')
	  READ (2,5216) (MMC(J),J= 1,NC),MMACID
	  CLOSE(2)
	  GO TO 5225
C*****APPORTION HYDROGEN TO MAKE SENSE OF A VALUES
5250  WRITE(LUNO,5251) BELL
5251  FORMAT (1X,A4,'ENTER COMPONENT# AND MULTIPLIER (2I2) ?',$)
	  READ (LUNI, 20, ERR=5250) NZC,NZM
	  IF(NZC.LE.0.OR.NZC.GE.NC) GO TO 5225
	  WRITE(LUNO,5252) BELL,NAME(NC),MMC(NC),MMACID
5252  FORMAT (1X,A4,A8,F10.5,'AND EXCESS ACID' F9.5, 'CONVERT TO')
	  TOTMNC = MMC(NC) + MMACID
	  MMC(NC) = NZM*MMC(NZC)
	  IF(NZM.EQ.0) MMC(NC).00001
	  MMACID=TOTMNC-MMC(NC)
	  WRITE(LUNO,5253) NAME(NC),MMC(NC),MMACID
5253  FORMAT (1X,A10,F10.5,' AND EXCESS √ÅCID ',F9.5)
	  GO TO 5225
C*****ADD OR DROP DATA POINT
5300  WRITE(LUNO,5301) BELL
5301  FORMAT (1X,A4,'"1" = ADD "-1" = DROP A POINT',$)
	  READ (LUNI,5306,ERR= 5300) NDA
	  IF(NDA.EQ.-1) GO TO 53011
	  IF(NDA.EQ.1) GO TO 53501
	  GO TO 5300
53011 WRITE(LUNO,5302) BELL, (I,VB(I),PH(I),I=1,NDP)
5302  FORMAT (1X,A4,/,(5X,110,2F8.3))
5303  WRITE(LUNO,5304) BELL
5304  FORMAT (1X,A4,
	 X'REMOVE WHICH POINT("-1" RELIST "0" RETURN)?', I2,$)
	  READ (LUNI,5306,ERR=5303) NREM
	  FORMAT(I2)
	  IF(NREM.EQ.0.OR.NREM.GT.NDP) GOTO 53528
	  IF(NREM.LT.0) GOTO 53011
	  NDP = NDP - 1
	  I2=I2-1
	  DO 5308 I = INREM,NDP
	  VB(I) =VB(I+1)
	  PH(I) = PH(L + 1)
5308  CONTINUE
	  GO TO 53011
53501 WRITE(LUNO, 5302) BELL(I, VB(I), PH(I),I= 1, NDP)
53502 WRITE(LUNO,5352) BELL
5352  FORMAT(1X, A4,
	  X'ADD IN FRONT F WICH PINT("-1" RELIST    "0" RETURN)?',$)
	  READ(LUNI, 5306, ERR = 53502) NADD
	  IF(NADD.EQ.0.OR.NADD.GT.NDP) GO TO 53528
      IF(NADD.LT.0) GO TO 53501
53521 WRITE(LUNO,53522) BELL
53522 FORMAT (1X,A4, 'VOLUME BASE ?',$)
	  READ(LUNI, 5216,ERR=53521) VOLBAS
	  NADDM = NADD -1
	  IF(NADDM.EQ.0) NADDM=NADD
	  IF(VOLBAS.EQ.VB(NADD).OR.VOLBAS.EQ.VB(NADDM)) GOTO 53521
53523 WRITE(LUNO, 53524) BELL
53524 FORMAT(1X,A4,'  LOG (H+)?',$)
	  READ( LUNI, 5216, ERR=53523) PEEH
	  IF(PEHH.EQ.PH(NADD).OR.PEEH.EQ.PH(NADDM)) GOTO 53523
	  DO 52525 I=NADD,NDP
	  II=NDP+NADD I
	  VB(II+1) = VB(II)
52525 PH(II+1) = PH(II)
	  VB(NADD) = VOLBAS
	  PH(NADD) = PEHH
	  NDP = NDP+1
	  IS = IS+1
	  GO TO 53501
52526 MM=1
	  CALL INPUT(MM)
	  MM = 0
	  NDUM = -2
	  CALL BODY(NDUM)
	  GO TO 70
	  END	  

	  SUBROUTINE STOICHING(NC,NS)
	  IMPLICIT REAL*8 (A-H,O-Z) 
	  DOUBLE PRECISION X(3), Y(3), NAME
	  DIMENSION VB(111), PH(111), NAME(7),TITLE(20), P(7)
	  DIMENSION PMME(7), PLBETA(111)
	  REAL*8 MMC(7), LBETA(111)
	  INTEGER*2 BELL
	  CHARACTER*3 ADJ
	  INTEGER IS(111,7), IC(7), MREF(7), FCT
	  COMMON /AINP/ SIGFIT, IS, IC, VB, PH, LBETA, MMC, NAME, TITLE
	  COMMON /FFFF/ X,V,XX
	  COMMOM /GGGG/ NREF
	  COMMON /LLLL/ LUNI, LUNO
	  COMMOM /MMMM/ ADJ
	  DATA LIMCNT /5/, BELL /7/
	  MCOUNT = 0
	  MM = 1
	  WRITE(LUNO, 600) BELL
600	  FORMAT(1X, A4 'REFINEMENT OF STOICHIOMETRY',/)
	  WRITE(LUNO, 6001)
6001  FORMAT(' CAUTION: Refinement of stoichiometric parameters'
	 1'is usually',/,10x,'s highly questionable procedure and'
	 2 'should be avoided',//)
	  WRITE(LUNO,601(I,NAME(I),MMC(I),I=1,NC)
601	  FORMAT(1X,I3,1X,AB,F10.5,3X,' MMOLES')
6011  WRITE(LUNO,6001)
602   FORMAT(1X,' COMPONENT NUMBERS(7I2) ?',$)
	  READ(LUNI,603,ERR=6011) (MREF (I),I=1,NC)
603	  FORMAT (7I2)
6031  WRITE(LUNO,604) BELL
604	  FORMAT(1X, A4, 'ENTER SMALL INCREMENT',$)
	  READ(LUNI,605,ERR=6031) PP
605	  FORMAT(F10.6)
	
	  IF(PP.EQ.0.0) RETURN
	  FCT = 2
6051  WRITE(LUNO,610) BELL,LIMCNT
610	  FORMAT(1X,A4, 'ENTER MAX # ITERATIONS (default', 1|3,')',$)
C*****NQUIT is a flag; 01 will FORTRAN STOP at end of this subroutine
	  READ (LUNI,603, ERR=6051) LIMCNT,NQUIT
	  if (limcnt.eq.99)limcnt=999
	  IF (LIMCNT.EQ.0) LIMCNT=5
	  CALL INPUT (MM)
	  NDUM=0
	  CALL BODY (NDUM)
	  CALL REFINE
	  WRITE(LUNO,607) (MMC (I),I=1,NC),SIGFIT
	  NREF=1
	  DO 10 I=1,NC
	  PMMC(I) = MMC(I)
10	  P(I) = PP
	  DO 11 I=1,NS
11	  PLBETA (i) = LBETA(I)
	  PSIGMA=SIGFIT
100	  SO= SIGFIT
105	  J=0
110	  S1=SIGFIT
	  J=J+1
	  M=MREF(J)
	  IF(M.GT.0)GO TO 120
	  GO TO 300
120   X(1) = MMC(M)
	  Y(1) = S1
	  MMC(M)= MMC(M) + P(J)
	  CALL INPUT (MM)
	  NDUM=0
	  CALL BODY(NDUM)
	  WRITE(LUNO,607) (MMC (1),I=1,NC),SIGFIT
	  S2 = SIGFIT
	  X(2) = MMC(M)
	  Y(2) = S2
	  IF(S2.LE.S1) GO TO 130
	  P(J)=-P(J)
	  MMC(M)=MMC(M) +2*P(J)
	  GO TO 140
130	  MMC(M)= MMC(M) + P(J)
140	  CALL INPUT (MM)
	  NDUM=0
	  CALL BODY (NDUM)
	  WRITE (LUNO,609) (MMC (I),I=1,NC),SIGFIT
	  S3=SIGFIT
	  X(3) = MMC(M)
	  Y(3)= S3
	  CALL PARB
	  Z1 = ABS(MMC(M)-XX)
	  Z2= ABS(P(J))*FCT
	  IF (Z1.LE.Z2) GO TO 150
	  x(1) = X(2)
	  Y(1) = Y(2)
	  X(2) = X(3)
	  Y(2) = Y(3)
	  GO TO 130
150	  MMC(M)=XX
	  CALL INPUT (MM)
	  NDUM=0
	  CALL BODY (NDUM)
	  WRITE(LUNO,609) (MMC (I),I=1,NC), SIGFIT

160   IF(J.LT.NC) GO TO 110
300   CONTINUE
      NCOUNT= NCOUNT+1
      WRITE(LUNO,606) NCOUNT
606   FORMAT (1X, 'Refining Beta (s)****************',
     1'****************',I6)
	  CALL REFINE
	  WRITE(LUNO,6072) SIGFIT, (LBETA(I),I=1,NS)
6072  FORMAT(1X,'SIG(    )=',F8.6,2X,6(F8.4,1x),/,
	 X (19X,F8.4, 1x, F8.4, 1x,
     1 F8.4,1x, F8.4,1x, F8.4,1x,F8.4,1x))
      WRITE(LUNO,607)
      SOMSF= S0-SIGFIT
	  WRITE(LUNO,609) (MMC (I),I=1,NC),SIGFIT,SOMSF
609   FORMAT('+',8F10.6)
607   FORMAT (1X,8F10.6)
	  COUNT=0.00000
690   DO 710 I=1,NS
	  DIFF=LBETA(I)-PLBETA(I)
	  PLBETA(I)=LBETA(I)
710   LBETA(I)=LBETA(I)+DIFF*0.66666
      DO 720 I=1,NC
      DIFF=MMC(I)-PMMC(I)
      PMMC(I)=MMC(I)
720   MMC(I)=MMC(I)+DIFF*0.66666
      PSIG=SIGFIT
      NDUM=0
      CALL BODY (NDUM)
      COUNT=COUNT +1.0000
      WRITE(LUNO,6075) (MMC(I),I=1,NC), SIGFIT,COUNT
6075  FORMAT(' ',8F10.6)
      IF(SIGFIT.LT.PSIG.AND.COUNT.LT.11) GO TO 690
      DO 740 I=1,NS
740	  LBETA(I)=PLBETA(I)
	  DO 750 I=1,NC
750	  MMC(I)=PMMC (I)
	  SIGFIT=PSIG
	  WRITE (LUNO,607) (MMC (I),I=1,NC),SIGFIT
	  IF(NCOUNT.GE.LIMCNT) GOTO 170
	  IF ((S0-SIGFIT).GE.0.0000005) GO TO 100
170   IF(NCOUNT.GE.LIMCNT) WRITE(LUNO,6071)
6071  FORMAT(' ITERATION LIMIT EXCEEDED')
      WRITE(LUNO,608) BELL
608   FORMAT (1X,A4,'*** END OF MMOLE REFINEMENT ***')
C*****ADJ="YES" IS A FLAG TO "OUTPUT" TO INDICATE "STOICH" WAS USED
      ADJ= 'YES'
      NREF=0
      IF(NQUIT.EQ.1) STOP
      RETURN
      END


	  SUBROUTINE INPUT(MM)
	  IMPLICIT REAL*8 (A-H,O-Z)
	  DOUBLE PRECISION NAME,RNAM
	  DIMENSION RCC(111,7), TITLE (20), VB(111), PH(111),NAME(7)
	  DIMENSION AA(111,7),T(111,7)
	  DIMENSION CC(7),CS(111),Y(7),PHCALC(111),A(7,7)
	  DIMENSION D(7),BLER(111)
	  REAL *8 MMC(7),LBETA(111), MMACID, NB
	  INTEGER *2 BELL
	  INTEGER IS(111,7),IC(7)
	  CHARACTER *2 ECHO
	  COMMON/AINP/ SIGFIT,IS,IC,VB, PH,LBETA,MMC,NAME,TITLE
	  COMMON/AAAA/ BELL,I1,I2,ISTEP,NDP,NS, NC,AA,RCC,T
	  COMMON/BBBB/ PHCOR,VO,NB,MMACID
	  COMMON/CCCC/ CC,CS,PHCALC
	  COMMON/DDDD/ NOPT,FAST
	  COMMON/EEEE/ A
	  COMMON/KKKK/ BLER
	  COMMON/LLLL/ LUNI,LUNO
	  DATA ECHO/'N'/
	  IF(MM.EQ.1) GO TO 111
	  OPEN (4,FILE='FOR004.DAT',STATUS='OLD')
	  WRITE(LUNO,6610) BELL
6610  FORMAT(A4, 'Do you want input file ECHO (Y/N) ?',$)
	  READ (LUNI,6611) ECHO
6611  FORMAT(A1)
	  IF(ECHO.EQ.'y') ECHO ='Y'
	  IF(ECHO.EQ.'Y') WRITE(LUNO,610)
610	  FORMAT( 'DISK INPUT FILE ECHO:')
	  READ (4,601) (TITLE(I),I=1,20)
601	  FORMAT (20A4)
	  IF(ECHO.EQ. 'Y') WRITE(LUNO,611) (TITLE(I),I=1,20)
611	  FORMAT (1X,20A4)
	  K=1
10	  READ (4,602) RNAM,RMMC,RRCC
602	  FORMAT (A8,3F8.5)
	  IF(ECHO.EQ.'Y')WRITE(LUNO,612) RNAM,RMMC,RRCC
612	  FORMAT (1X,A8,3F8.5)
      IF(RMMC.LE.0.) GO TO 12 
	  NAME(K)=RNAM
	  MMC(K)=RMMC
	  RCC(1,K)=RRCC
	  IF(RCC(1,K).NE.0.) RCC(1,K) = 10.0**RCC(1,K)
	  K=K+1
	  GO TO 10
12	  NC=K-1
	  NCM1 = NC-1
	  READ(4,502) VO,NB,MMACID, PHCOR
	  IF(ECHO.EQ.'Y') WRITE (LUNO,503) VO, NB, MMACID, PHCOR
503	  FORMAT (1X,9F8.4)
	  I = 1
100	  READ (4,603) LBETA(I), (IC(K),IS(I,K),K=1,NC)
603	  FORMAT(F8.5,14(I2,I3))
	  IF(ECHO.EQ.'Y')
	 X WRITE(LUNO,613) LBETA(I), (IC(K), IS(I,K), K=1, NC)
613   FORMAT(1X,F9.5,14(I2,I3,2X))
C*****INITIALIZING BLER ONLY WHEN FOR004.DATA IS READ OR REREAD	 
	  BLER(I)=0
	  IF(IC(1).EQ.0) GO TO 102
	  I=I+1
	  GO TO 100
102	  NS= I-1
101   CONTINUE
105	  I = 1
104	  READ (4,502, END=106) VB(I),PH(I), (RCC(I,K), K=1,NC)
	  IF(ECHO.EQ.'Y')
	 X WRITE(LUNO,502) VB (I),PH (I), (RCC(I,K),K=1,NC)
502	  FORMAT(10F8.4)
	  IF(RCC(1,NCM1).EQ.0.0) WRITE(LUNO,633) BELL
633	  FORMAT (1X,A4, 'FIRST DATA POINT NEEDS A GUESS VALUE')
	  I=I+1
	  GO TO 104
106	  IF(ECHO.EQ.'Y') WRITE(LUNO,630)
630	  FORMAT('INPUT ECHO COMPLETE')
	  NDP = I-1
	  REWIND 4
      CLOSE (4)
111   DO 110 I=1,NDP
	  V = V0 + VB(I)
	  CB = VB(I) * NB/V
	  DO 109 K=1,NCM1
	  IF(MM.EQ.0.AND.RCC(I,K).LT.0.) RCC(I,K)= 10.0**RCC (I,K)
	  T(I,K)=MMC(K)/V
109   AA(I,K)=CB/T(I,K)-MMACID/MMC(K)
	  T(I,NC) = (MMC(NC)-NB*VB(I)+ MMACID)/V
	  AA(I,NC)= (CB*V -MMACID)/MMC(NC)
	  IF(RCC(I,NC).LT.0.0) RCC(I,NC)= 10.0**RCC(I,NC)
	  IF(RCC(I,NC).EQ.0.0) RCC(I,NC) = 10.0**(-PH(I))
110   CONTINUE
	  RETURN
	  END
	

	  SUBROUTINE OUTPUT
	  IMPLICIT REAL*8 (A-H,O-Z)
	  DOUBLE PRECISION NAME
	  DIMENSION RCC(111,7), TITLE(20),VB(111), PH(111),NAME(7)
	  DIMENSION AA(111,7),T(111,7)
	  DIMENSION CC(7),CS(111),Y(7),PHCALC(111),A(7,7)
	  DIMENSION CCL(7),D(7),BLER(111)
	  DIMENSION NI(111), NEG(111)
	  REAL*8 MMC(7),LBETA(111), MMACID, NB
	  INTEGER BELL,FF,DAT1, DAT2, DAT3,TIM1,TIM2, TIM3,TIM4
	  INTEGER IS(111,7),IC(7)
	  CHARACTER *1 AV,NIP,NPPR,NW
	  CHARACTER *3 ADJ
	  COMMON/AINP/ SIGFIT, IS, IC,VB, PH,LBETA,MMC,NAME,TITLE
	  COMMON/AAAA/ BELL,I1,I2,ISTEP,NDP,NS, NC,AA,RCC,T
	  COMMON/BBBB/ PHCOR,V0,NB,MMACID
	  COMMON/CCCC/ CC,CS,PHCALC
	  COMMON/DDDD/ NOPT,FAST
	  COMMON/EEEE/ A
	  COMMON/HHHH/ DLB,KCVERR, BETERR,SGF,BERBET
	  COMMON/NEG/ NEGF,NEG
	  COMMON/LLLL/ LUNI,LUNO
	  COMMON/MMMM/ ADJ
	  COMMON/KKKK/ BLER
	  DATA FF/12/,AV/'A'/
C*****DATE AND TIME CALLS:
	  CALL GETDAT(DAT1, DAT2,DAT3)
	  CALL GETTIM(TIM1,TIM2, TIM3,TIM4)
	  N1=I1
	  N2=I2
	  NSTEP=ISTEP
	  DO 87 L=1,NS
87	  NEG(L)=0
	  IF(NEGF.EQ.1) GO TO 6181
	  N=0
90	  WRITE(LUNO,598) BELL
598	  FORMAT (1X,A4,'5=TERMINAL 1=DISK 0=RETURN ? ',$)
	  READ(LUNI,5991) NPPR
572	  FORMAT(I3)
	  IF(NPPR.EQ.'1'.OR.NPPR.EQ.'5') GO TO 100
599   FORMAT(I2)
	  RETURN
	  GO TO 90
100	  WRITE(LUNO,611) BELL
611	  FORMAT(1X,A4,'1=DATA 2=A-VALUES 3=SPECIES =RESULTS ? ',$)
	  READ(LUNI,5991) NW
	  IF(NPPR.EQ.'5') NPR=LUNO
	  IF(NPPR.EQ.'1') NPR=1
	  IF(NW.EQ.'1') GO TO 11
	  IF(NW.EQ.'2') GO TO 22
	  IF(NW.EQ.'3') GO TO 33
	  IF(NW.EQ.'4') GO TO 44
	  GO TO 90
11	  WRITE(NPR,600) FF, (TITLE (I),I=1,20)
600	  FORMAT(A2, 10X, 'Program BEST vers. 10/10/91',
	 X //,10X,80A4)
	  WRITE(NPR,6001) DAT2, DAT3, DAT1, TIM1,TIM2
6001  FORMAT (10X, 'DATE AND TIME',
	 X 7X, I2.2,'-' ,I2.2,'-',I4.4,5X, I2.2,':'I2.2)
	  WRITE(NPR,601) V0,NB,MMACID, NDP,PHCOR
601	  FORMAT(10X,'INITIAL VOLUME', 16X,F10.5,/,
	 X 10X, 'NORMALITY OF BASE', 13X,F10.5,/,
	 X 10X,'MILLIMOLES ACID',15X,F10.5,/,
	 X 10X, 'NUMBER DATA POINTS', 12X,I10,/,
	 X 10X,'PH CORR. INCLUDED',13X,F10.3,/)
	  WRITE (NPR,602)
602	  FORMAT (1X, 'COMPONENTS:')
	  WRITE (NPR,603) (K,NAME(K), MMC(K),K=1,NC)
603	  FORMAT (1X,I9,A9,F11.5,' MILLIMOLES')
	  IF(ADJ.EQ.'YES'.AND.NPR.EQ.1) WRITE(NPR,6051)
6051  FORMAT(' NOTE: millimoles were adjusted')
	  WRITE(NPR,604)
604	  FORMAT(/,' SPECIES:',/4X, 'LOG BETA')
	  DO 130 I=1, NS
130	  WRITE(NPR,605)
	  1 I,LBETA (I), (IS(I,K),NAME(K),K=1,NC)
605	  FORMAT(1X,I2,1X, F9.4,1X,8(I3,1X,A8))
	  WRITE(NPR,661) SIGFIT
	  WRITE(NPR,6052)	
6052  FORMAT(/,' DIFFERENCE TABLE: DIFF=LOGBETA(I)-LOGBETA(I-1)',/
	 X 1X,'I',' DIFF',5X,'ERROR')
	  DLBETA=LBETA(1)
	  DO 1301 I=1,NS
1302  IF(I.EQ.1) GO TO 1301
	  DLBETA=LBETA(I)-LBETA(I-1)
1301  WRITE(NPR,6055) I,DLBETA, BLER(I)
6055  FORMAT (1X, I2,2F10.4)
	  WRITE (NPR,608)
	  GO TO 100
22	  WRITE (NPR,606) FF, (AV,K,K=1,NC)
606	  FORMAT (A2,/,8X, 'VB',7X, 'PH',9 (7X,A1,I1))
	  DO 131 I=I1,I2,ISTEP
131	  WRITE (NPR,607) VB(I),PH(I), (AA(I,K), K=1,NC)
607	  FORMAT (1X,13F9.3)
	  WRITE (NPR,608)
608	  FORMAT (1X,/)
	  GO TO 100
33	  WRITE(LUNO,613) BELL
613	  FORMAT (1X,A4,' 1=INDIVIDUAL SPECIES MODE',
	X' 2=PERCENTAGE SPECIES MODE ? ',$)
	  DO 197 I=1,NS
197	  NI(I)=0
200	  READ (LUNI,5991) NIP
5991  FORMAT(A1)
	  IF(NIP.EQ.'1') GO TO 210
	  IF(NIP.EQ.'2') GO TO 220
	  GO TO 33
210	  WRITE(LUNO,609) BELL
609	  FORMAT (1X,A4,' ENTER INDIVIDUAL SPECIES (40I2)')
	  READ(LUNI,211,ERR=210) (NI(I), I=1, NS)
211	  FORMAT(40I2)
220   WRITE(LUNO,614) BELL
614   FORMAT(1X,A4,' MINIMUM PER CENT ? ',$)
      READ (LUNI,615,ERR=220) WR
615   FORMAT (F8.3)
   	  WRP=WR/100.*T(1,1)
212   WRITE(LUNO,616) BELL
616   FORMAT(1X,A4,'N1,N2(-1),NSTEP? (3I2)? ',$)
	  READ(LUNI,211,ERR=212) N1,N2,NSTEP
	  IF(NSTEP.LE.O) NSTEP = 1
	  IF(N1.LT.I1.OR.N2.GT.I2) GO TO 212
	  IF(N2.EQ.-1) N2=I2
	  WRITE(NPR,618) FF
618   FORMAT (A2,/,3X,'#',1X,'LOG BETA',5X,'MOLARITY',6X,'%')
6181  DO 300 I=N1, N2,NSTEP
C*****criterion for negligible species
      TEST=.000001*T(I,1)
	  DO 240 K=1,NC
240	  CCL(K)=ALOG10(RCC (I,K))
	  DO 141 L=1,NS
1403  PL=PL+CCL(K)*IS(L,K)
	  CSL=PL+LBETA(L)
	  CS(L)=10.0**CSL
C*****test for negligible species
	  IF(NEG(L).EQ.1) GOTO 141
	  IF(CS(L).GT.TEST) NEG(L) = 1
141	  CONTINUE
	  IF(NEGF.EQ.1) GOTO 300
	  WRITE(NPR,6171) PH(I),I
6171  FORMAT(' pH=',F7.3,'('1I3,')')
	  DO 290 L=1,NS
	  IF(NIP.EQ.'2') GO TO 144
	  DO 142 J=1,40
142	  IF(L.EQ.NI(J)) GO TO 144
	  GO TO 290
144	  IF(CS(L).LT.WRP) GO TO 290
	  PRO=CS (L)*100./T(1,1)
	  WRITE (NPR,617) L,LBETA(L),CS(L),PRO, (IS(L,K),NAME(K),K=1,NC)
617	  FORMAT (1X,I3,2X,F7.3,2X, 1P,E11.3,0P,F7.2,1X,7 (I2,1X,A7))
290	  CONTINUE
300	  CONTINUE
	  IF(NEGF.EQ.1) RETURN
	  GO TO 100
44	  WRITE (NPR,630) FF
630	  FORMAT (A2,/,15X, 'VB',9X,'A',8X, 'PH',4X, 'PHCALC',6X, 'DIFF')
	  DO 288 I=I1,I2,ISTEP
	  DD=0
	  IF(PHCALC(I).NE.0) DD=PH(I)-PHCALC(I)
	  WRITE (NPR,631) I,VB(I),AA(I,1),PH(I),PHCALC(I),DD
631	  FORMAT (1X,I3,3X,5F10.3)
288	  CONTINUE
	  WRITE(NPR,661) SIGFIT
661	  FORMAT(/,10X, 'SIGMA PH FIT=',F10.6)
	  GO TO 100
	  END
	  
	  SUBROUTINE BODY(N)
	  IMPLICIT REAL*8 (A-H,O-Z)
	  DOUBLE PRECISION NAME
	  DIMENSION RCC(111,7), TITLE (20),VB (111), PH(111), NAME(7)
	  DIMENSION AA (111,7),T(111,7)
	  DIMENSION CC(7),CS(111),Y(7), PHCALC(111),A(7,7)
	  DIMENSION FP(7,7),F(7),CCL(7), D(7)
	  DIMENSION W(111)
	  REAL*8 MMC (7), LBETA (111), MMACID,NB
	  INTEGER*2 BELL
	  INTEGER IS(111,7), IC(7)
	  COMMON/AINP/ SIGFIT,IS, IC,VB,PH,LBETA,MMC,NAME,TITLE
	  COMMON/AAAA/ BELL,I1,I2, ISTEP,NDP,NS, NC,AA,RCC,T
	  COMMON/BBBB/ PHCOR,V0,NB, MMACID
	  COMMON/CCCC/ CC,CS,PHCALC
	  COMMON/DDDD/ NOPT,FAST
	  COMMON/EEEE/ A
	  COMMON/LLLL/LUNI,LUNO
	  COMMON /HHHH/ DLB,KCVERR, BETERR,SGF,BERBET
	  DATA NFIR/1/,SW/0.0/
C***** -2 OR FORCES RECOMPUTATION OF WEIGHTING FACTORS
C***** FROM EITHER ADD-DROP OPTION OR '27'
	  IF(N.EQ.-2.OR.N.EQ.1) NFIR=1
C*****SQUARED WEIGHING FACTORS
	  DO 1383 I=2,NDPM1
	  W(I)=1/(PH(I+1)-PH(I-1))**2
1383  CONTINUE
C*****.25 is 1/2**2
      W(1)=.25/(PH (2)-PH(1))**2
	  W(NDP) =.25/(PH(NDP)-PH(NDPM1))**2
138	  NFIR=0
	  ITEND=30
	  UNDER = 10.**(-355.)
	  NDPM1=-1
C*****SET UP F(J)'S AND FP(J1,J2)'S
	  SIGFIT=0.0
	  SW=0
	  SNEG =T(NDP, 1)*(1.0E-8) *FAST
	  SLNEG=ALOG10(SNEG)
	  I=I1-ISTEP
139	  CONTINUE
	  I=I + ISTEP
	  SW=SW+W(I)
	  IM1=I-ISTEP
	  IM2=I-2*ISTEP
	  IF(I.GT.I2) GO TO 200
1240  CONTINUE
1250  DO 1388 K=1,NC
	  IF(RCC(I,K).LE.0.0) N=1
	  IF(N) 1387,1387,1381
1381  IF(I.EQ.I1) CC(K)=RCC(I,K)
	  IMSTEP = I-ISTEP
	  IF(I.GT.I1) CC(K)= RCC(IMSTEP,K)
	  IF(I.GT.(I1+ISTEP)) GO TO 1384
	  GO TO 1388
1384  CALL NEXT (RCC (IM2,K), RCC (IM1,K), VB (IM2), VB (IM1),VB().CC(K))
	  GO TO 1388
1387  CC(K)=RCC(I,K)
1388  CONTINUE
1260  DAMP=1:
1389  ITER=0
1390  ITER=ITER+1
      DO 1395 K=1,NC
1395  IF(CC(K).GT.0.0) CCL(K)=ALOG10(CC(K))
	  

	


	